#!/usr/bin/env python3

import sys, time, datetime, random, os, shlex

from myeventloop import Timeout, Log, LOG_INFO, LOG_DEBUG
from tcpserver import *
from tcpclient import *
from tratador import *
from tratador_fotos import *

Log.set_level(LOG_INFO)

def heartbeat(to_obj):
    Log.info("receptor em funcionamento")
    to_obj.reset(86400)

Timeout.new("heartbeat", 30, heartbeat)

host = "0.0.0.0"
port = int(sys.argv[1]) or 9009  # Porta deste Receptor IP
cport = int(sys.argv[2]) or 9009 # Porta da central de alarme
senha = int(sys.argv[3])         # Senha de acesso remoto (usuário 98)
tam_senha = int(sys.argv[4])     # Tamanho da senha (4 ou 6 dígitos)

Tratador.tratador_de_fotos = TratadorDeFotos(cport, senha, tam_senha)

ev = TCPServerEventLoop((host, port), TCPListener, Tratador)

def watchdog(to_obj):
    centrais_conectadas = 0
    for h in Handler.items.values():
        if isinstance(h, Tratador):
            centrais_conectadas += 1
    if not centrais_conectadas:
        Log.info("nenhuma central conectada")
    to_obj.reset(3600)

Timeout.new("watchdog", 60, watchdog)

ev.loop()
